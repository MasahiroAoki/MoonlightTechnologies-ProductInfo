# EvoSpikeNet: Data Handling Guide

This document details how to create, output, and validate AI data (spike data) used in the `EvoSpikeNet` framework.

## 1. Main Sources of Spike Data

Spike data can be obtained or generated from various sources. Here are the main examples.

### 1.1. Algorithmic Generation
This method involves generating artificial spike data using algorithms for testing or specific feature validation.
- **Random Data**: Useful for basic network operation validation, generating random spikes with a specific firing rate using methods like a Poisson distribution.
- **Artificial Patterns**: Designing intentional spike patterns, such as synchronous firing of specific neuron groups, to test the network's learning or pattern recognition capabilities.

### 1.2. Conversion from Existing Data
This approach converts common data types into spike data that can be handled by an SNN.
- **Image Data (e.g., MNIST)**: Static images can be converted into spike data through "rate encoding," where the brightness of each pixel is converted into the firing rate of a neuron over a certain period. Brighter pixels fire more frequently.
- **Audio/Time-Series Data**: Audio waveforms or sensor time-series data can be converted into spike data by encoding changes or magnitudes in their values into the timing or frequency of spikes.

### 1.3. Direct Input from Neuromorphic Sensors
Sensors built to mimic the biological nervous system output native spike data.
- **Event-Based Cameras (DVS)**: Unlike traditional cameras that output frames, these cameras asynchronously output "events (spikes)" when each pixel detects a change in brightness. This provides very fast and low-redundancy visual information.

---

## 2. How to Create Data

Input data for the model must be spike data that follows a specific format.

### Data Specifications

- **Format**: `torch.Tensor`
- **Shape**: A 2D tensor of `(time_steps, num_input_neurons)`.
- **dtype**: `torch.int8`
- **Device**: `'cuda'`
- **Values**: Binary values of `0` or `1`.

### Data Generation Script

The project includes a script, `scripts/generate_spike_data.py`, for generating sample spike data that can be used for tests and experiments.

#### How to Use

This script is run from the command line. You can customize the characteristics of the generated dataset with the following arguments.

```bash
python scripts/generate_spike_data.py --num-samples 1000 --time-steps 250 --firing-rate 15 --output-file my_dataset.pt
```

**Key Arguments:**
- `--num-samples`: The number of data samples to generate.
- `--time-steps`: The number of time steps for each sample.
- `--num-neurons`: The number of neurons for each time step.
- `--firing-rate`: The average firing rate of neurons (in Hz). Spikes are generated based on a Poisson distribution.
- `--output-file`: The output filename. Saved in `.pt` format.
- `--no-cuda`: If this flag is set, data will be generated and saved on the CPU.

#### Generated Data

The script saves a PyTorch tensor to the specified `output-file`. The data is in a dictionary format with the following keys:
- `data`: The spike data itself, with a shape of `(num_samples, time_steps, num_neurons)`.
- `labels`: Dummy labels corresponding to each sample, with a shape of `(num_samples,)`.

### How to Load Data

Data generated by the script can be easily loaded using `torch.load()`.

```python
import torch

# Check if CUDA is available
device = 'cuda' if torch.cuda.is_available() else 'cpu'

# Load the data and place it on the appropriate device
dataset = torch.load('my_dataset.pt', map_location=device)

# Retrieve the data
spike_data = dataset['data']
labels = dataset['labels']

print("Loaded dataset:")
print(f"  - Data shape: {spike_data.shape}")
print(f"  - Labels shape: {labels.shape}")
print(f"  - Device: {spike_data.device}")

# To use in an SNN model, retrieve an individual sample.
# In this example, the model expects a shape of (time_steps, num_neurons),
# so the batch dimension needs to be removed.
first_sample = spike_data[0]
print(f"\nShape of a single sample passed to the model: {first_sample.shape}")
```

## 3. How to Output Data

The result of the model's simulation is spike data from the output layer.

### Output Data Specifications
The output data has essentially the same specifications as the input data.
- **Format**: `torch.Tensor`
- **Shape**: `(time_steps, num_output_neurons)`
- **dtype**: `torch.int8`
- **Device**: `'cuda'`
- **Values**: `0` or `1`

### Sample Code
```python
# Assuming an SNNModel instance is stored in a variable 'model'
# 'input_spikes' is the data created in Section 2
output_spikes = model.forward(input_spikes)
print("Output data shape:", output_spikes.shape)
```

## 4. Data Validation Procedure
It is important to validate that the data is in the correct format before passing it to the model.

### Validation Checklist
1.  **Type Check**: Is the data a `torch.Tensor`?
2.  **Dimension Check**: Is the tensor 2-dimensional?
3.  **Shape Check**: Does the second dimension of the tensor match the number of input neurons in the model?
4.  **dtype Check**: Is the data type `torch.int8`?
5.  **Device Check**: Is the tensor on the `'cuda'` device?
6.  **Value Check**: Are all values in the tensor either 0 or 1?

### Sample Validation Function
```python
import torch
from evospikenet.core import SNNModel

def validate_input_spikes(input_tensor: torch.Tensor, model: SNNModel) -> bool:
    """
    Validates if the input spike tensor is valid for the SNN model.
    """
    try:
        # 1. Type Check
        assert isinstance(input_tensor, torch.Tensor), "Input is not a torch.Tensor"

        # 2. Dimension Check
        assert input_tensor.dim() == 2, f"Input tensor must be 2D, but got {input_tensor.dim()} dimensions"

        # 3. Shape Check (match against input layer neuron count)
        expected_neurons = model.layers[0].num_neurons
        actual_neurons = input_tensor.shape[1]
        assert actual_neurons == expected_neurons, \
            f"Input neuron count mismatch. Model expects {expected_neurons}, but tensor has {actual_neurons}"

        # 4. dtype Check
        assert input_tensor.dtype == torch.int8, f"Input dtype must be torch.int8, but got {input_tensor.dtype}"

        # 5. Device Check
        # Assume the model's device by getting the device of its first parameter
        model_device = next(model.parameters()).device
        assert input_tensor.device == model_device, \
            f"Device mismatch. Model is on {model_device}, but tensor is on {input_tensor.device}"

        # 6. Value Check (only 0s or 1s)
        assert torch.all((input_tensor == 0) | (input_tensor == 1)), "Input tensor values must be binary (0 or 1)"

        print("✅ Validation successful: Input tensor is valid for the SNN model.")
        return True

    except AssertionError as e:
        print(f"❌ Validation failed: {e}")
        return False
```

---

## 5. Data Sources for Text Corpora

Training the language model (`EvoSpikeNetLM`) requires a text-based corpus. The `evospikenet/dataloaders.py` module provides a framework for uniformly loading text data from various sources.

### 5.1. Basic Design

-   **`CorpusLoader` (Base Class):**
    An abstract base class that all data loaders inherit from. It defines a `load(**kwargs)` method, delegating the logic for loading data from a specific source to its subclasses.

### 5.2. Implemented Loaders

-   **`WikipediaLoader`:**
    -   **Purpose:** To fetch a specified Wikipedia article using the `wikipedia-api` library.
    -   **Usage:** Called by passing the article title, like `load(page_title="Article Title")`.
-   **`AozoraBunkoLoader`:**
    -   **Purpose:** To extract the main text from an Aozora Bunko HTML page. It uses the `requests` and `BeautifulSoup4` libraries for web scraping.
    -   **Processing:** It removes furigana (reading aids) and other unnecessary HTML tags from the fetched HTML, returning only the clean text data.
    -   **Usage:** Called by passing the URL of an Aozora Bunko work page, like `load(url="URL of the work")`.
-   **`LocalFileLoader`:**
    -   **Purpose:** To read a text file (`.txt`) from the local file system.
    -   **Usage:** Called by passing the file path, like `load(file_path="path/to/file")`.
